<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg-primary: #0a0f1a; --bg-secondary: #111827; --border: #2a3441; --text-primary: #f1f5f9; --text-muted: #64748b; --accent: #10b981; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); padding: 12px; }

        .area-resumo { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; padding: 12px; text-align: center; }
        .card span { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }
        .card strong { display: block; font-family: 'JetBrains Mono'; font-size: 18px; color: var(--accent); }

        .table-container { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #1a2332; padding: 10px; font-size: 10px; text-transform: uppercase; color: var(--text-muted); text-align: left; }
        td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 12px; }
        
        .nome-membro { font-weight: 600; white-space: normal; word-break: break-word; max-width: 120px; }
        .tel-membro { font-family: 'JetBrains Mono'; font-size: 10px; color: var(--text-muted); }
        .valor-membro { font-family: 'JetBrains Mono'; font-weight: 700; color: var(--accent); text-align: right; }

        .linha-incerto td { background: rgba(245,158,11,0.05); color: #f59e0b; font-size: 10px; text-align: center; }

        @media (max-width: 600px) {
            .area-resumo { grid-template-columns: 1fr 1fr; }
            .card-total { grid-column: 1 / -1; }
            td, th { padding: 8px 5px; font-size: 11px; }
            .tel-membro { font-size: 9px; }
        }
    </style>
</head>
<body>
    <div class="area-resumo">
        <div class="card"><span>Ativos</span><strong id="totalAtivos">0</strong></div>
        <div class="card"><span>Média</span><strong id="mediaMembro">R$ 0</strong></div>
        <div class="card card-total"><span>Total</span><strong id="arrecadacaoTotal">R$ 0</strong></div>
    </div>
    <div class="table-container">
        <table>
            <thead><tr><th>Membro / Tel</th><th style="text-align:right;">Total</th></tr></thead>
            <tbody id="corpoMembros"></tbody>
        </table>
    </div>
    <script>
        const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTVFsO0U3JTeEpqIks1fpNUNiHF5J6Pgyv7yYiJKFgqyI08Y_sRB2nnikRvfT4W5CcwQwAW5r0Lvt1x/pub?output=csv';
        let registros = [];
        const fmt = v => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const padronizar = t => {
            let n = String(t).replace(/\D/g, "");
            return n.length > 8 ? `(${n.slice(-11,-9)}) ${n.slice(-9,-4)}-${n.slice(-4)}` : "N/A";
        };

        async function carregar() {
            const res = await fetch(url + '&cache=' + Date.now());
            const csv = await res.text();
            registros = csv.split('\n').slice(1).filter(l=>l.trim()).map(l=>{
                const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v=>v.replace(/^"|"$/g,'').trim());
                let [d,m,a] = c[0].split('/');
                return { tel: c[1].replace(/\D/g,""), nome: c[2].toUpperCase(), mesAno: `${m}/${a}`, ano: a, valor: parseFloat(c[3].replace(/[R$\s.]/g,'').replace(',','.')) || 0, cat: c[4].toLowerCase().includes("dizimo") ? "Dízimo" : c[4] };
            });
            renderizar();
        }

        function renderizar(cat="Todas", periodo="Todos") {
            const f = registros.filter(r => (cat === "Todas" || r.cat === cat) && (periodo === "Todos" || (periodo.length === 4 ? r.ano === periodo : r.mesAno === periodo)));
            const iden = {}, incer = [];
            let total = 0;
            f.forEach(r => {
                total += r.valor;
                if(r.nome.includes("INCERTO")) incer.push(r);
                else {
                    const k = r.tel || r.nome;
                    if(!iden[k]) iden[k] = { nome: r.nome, tel: r.tel, total: 0 };
                    iden[k].total += r.valor;
                }
            });
            const lista = Object.values(iden).sort((a,b)=>a.nome.localeCompare(b.nome));
            document.getElementById('totalAtivos').innerText = lista.length;
            document.getElementById('arrecadacaoTotal').innerText = fmt(total);
            document.getElementById('mediaMembro').innerText = fmt(lista.length ? total/lista.length : 0);

            let h = lista.map(m => `<tr><td><div class="nome-membro">${m.nome}</div><div class="tel-membro">${padronizar(m.tel)}</div></td><td class="valor-membro">${fmt(m.total)}</td></tr>`).join('');
            if(incer.length) {
                h += `<tr class="linha-incerto"><td colspan="2">REMETENTES INCERTOS</td></tr>`;
                h += incer.map(i => `<tr><td><div class="nome-membro">${i.nome}</div><div class="tel-membro">${padronizar(i.tel)}</div></td><td class="valor-membro">${fmt(i.valor)}</td></tr>`).join('');
            }
            document.getElementById('corpoMembros').innerHTML = h;
        }
        window.addEventListener('message', e => renderizar(e.data.categoria, e.data.periodo));
        carregar();
    </script>
</body>
</html>
