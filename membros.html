<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <style>
        :root {
            --primary: #2563eb;
            --success: #059669;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --bg-card: #ffffff;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; background: #f8fafc; margin: 0; color: var(--text-main); }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        th { background: #f1f5f9; padding: 14px; text-align: left; border-bottom: 2px solid #e2e8f0; color: var(--text-sub); font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 14px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        tr:last-child td { border-bottom: none; }
        
        .linha-separadora { border-top: 4px solid #e2e8f0 !important; background: #f8fafc; font-weight: bold; color: var(--text-sub) !important; text-align: center; }
        .texto-incerto { color: #94a3b8; font-style: italic; background: #fafafa; }
        .valor-membro { font-weight: 700; color: var(--text-main); text-align: right; }

        /* Container dos Cards */
        .area-resumo {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
            padding-bottom: 40px;
            flex-wrap: wrap;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px 30px;
            min-width: 220px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s;
        }
        
        .card:hover { transform: translateY(-5px); }

        .card span { font-size: 12px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }
        .card strong { font-size: 28px; margin-top: 8px; color: var(--text-main); }

        /* Estilos específicos por Card */
        .card-ativos { border-bottom: 5px solid var(--primary); }
        .card-ativos strong { color: var(--primary); }
        
        .card-total { border-bottom: 5px solid var(--success); }
        .card-total strong { color: var(--success); }

        @media (max-width: 600px) {
            .area-resumo { flex-direction: column; align-items: stretch; }
            .card { min-width: auto; }
        }
    </style>
</head>
<body>

    <table>
        <thead>
            <tr>
                <th>Membro</th>
                <th>Telefone</th>
                <th style="text-align: right;">Total Contribuído</th>
            </tr>
        </thead>
        <tbody id="corpoMembros"></tbody>
    </table>

    <div class="area-resumo">
        <div class="card card-ativos">
            <span>Membros Ativos</span>
            <strong id="totalAtivos">0</strong>
        </div>

        <div class="card card-total">
            <span>Arrecadação Total</span>
            <strong id="arrecadacaoTotal">R$ 0,00</strong>
        </div>
    </div>

    <script>
        const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTVFsO0U3JTeEpqIks1fpNUNiHF5J6Pgyv7yYiJKFgqyI08Y_sRB2nnikRvfT4W5CcwQwAW5r0Lvt1x/pub?output=csv';
        let registros = [];

        const padronizarTel = t => {
            let n = String(t).replace(/\D/g, "");
            if (n.length <= 11) n = "55" + (n.length <= 9 ? "24" : "") + (n.length === 8 ? "9" : "") + n;
            return n.length >= 12 ? `+${n.substring(0, 2)} (${n.substring(2, 4)}) ${n.substring(4, 9)}-${n.substring(9, 13)}` : "N/A";
        };

        const formatarMoeda = valor => valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        async function carregar() {
            try {
                const res = await fetch(url + '&cache=' + Date.now());
                const csv = await res.text();
                registros = csv.split('\n').slice(1).filter(l => l.trim()).map(l => {
                    const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());
                    let [d, m, a] = c[0].split('/');
                    return { 
                        telRaw: String(c[1]).replace(/\D/g, ""),
                        nome: c[2].toUpperCase().trim(), 
                        mesAno: `${m}/${a}`, 
                        ano: a,
                        valor: parseFloat(c[3].replace(/[R$\s.]/g, '').replace(',', '.')) || 0,
                        cat: c[4].toLowerCase().includes("dizimo") ? "Dízimo" : c[4]
                    };
                });
                renderizar();
            } catch (e) { console.error(e); }
        }

        function renderizar(cat = "Todas", periodo = "Todos") {
            const filtrados = registros.filter(r => {
                const matchCat = (cat === "Todas" || r.cat === cat);
                let matchPeriodo = (periodo === "Todos") || (periodo.length === 4 ? r.ano === periodo : r.mesAno === periodo);
                return matchCat && matchPeriodo;
            });

            const identificados = {};
            const incertos = {};
            let somaTotalGeral = 0;

            // Processar identificados e soma total
            filtrados.forEach(r => {
                somaTotalGeral += r.valor;
                if (!r.nome.includes("REMETENTE INCERTO")) {
                    const chave = r.telRaw || r.nome;
                    if (!identificados[chave]) identificados[chave] = { nome: r.nome, tel: r.telRaw, total: 0 };
                    identificados[chave].total += r.valor;
                }
            });

            // Processar incertos com fusão
            filtrados.forEach(r => {
                if (r.nome.includes("REMETENTE INCERTO")) {
                    if (r.telRaw && identificados[r.telRaw]) {
                        identificados[r.telRaw].total += r.valor;
                    } else {
                        const chave = r.telRaw || "SEM-TEL-" + Math.random();
                        if (!incertos[chave]) incertos[chave] = { nome: "REMETENTE INCERTO", tel: r.telRaw, total: 0 };
                        incertos[chave].total += r.valor;
                    }
                }
            });

            const listaIdentificados = Object.values(identificados).sort((a, b) => a.nome.localeCompare(b.nome));
            const listaIncertos = Object.values(incertos);

            // Atualizar os Cards
            document.getElementById('totalAtivos').innerText = listaIdentificados.length;
            document.getElementById('arrecadacaoTotal').innerText = formatarMoeda(somaTotalGeral);

            let html = listaIdentificados.map(m => `
                <tr>
                    <td><strong>${m.nome}</strong></td>
                    <td>${padronizarTel(m.tel)}</td>
                    <td class="valor-membro">${formatarMoeda(m.total)}</td>
                </tr>
            `).join('');

            if (listaIncertos.length > 0) {
                html += `<tr><td colspan="3" class="linha-separadora">⚠️ Remetentes não Identificados</td></tr>`;
                html += listaIncertos.map(m => `
                    <tr class="texto-incerto">
                        <td>${m.nome}</td>
                        <td>${padronizarTel(m.tel)}</td>
                        <td class="valor-membro">${formatarMoeda(m.total)}</td>
                    </tr>
                `).join('');
            }

            document.getElementById('corpoMembros').innerHTML = html;
        }

        window.addEventListener('message', e => renderizar(e.data.categoria, e.data.periodo));
        carregar();
    </script>
</body>
</html>