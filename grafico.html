<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --success: #059669;
            --text-main: #1e293b;
            --text-sub: #64748b;
        }

        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            padding: 20px; 
            background: #f8fafc; 
            margin: 0; 
            color: var(--text-main);
        }

        /* Container do Gráfico */
        #container-grafico { 
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            height: 65vh; 
            width: 100%; 
            box-sizing: border-box;
        }

        /* Container dos Cards (Mesmo estilo da aba Membros) */
        .area-resumo {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            padding-bottom: 30px;
            flex-wrap: wrap;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 15px 30px;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s;
        }
        
        .card:hover { transform: translateY(-3px); }

        .card span { font-size: 11px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }
        .card strong { font-size: 24px; margin-top: 5px; }

        .card-ativos { border-bottom: 5px solid var(--primary); }
        .card-ativos strong { color: var(--primary); }
        
        .card-total { border-bottom: 5px solid var(--success); }
        .card-total strong { color: var(--success); }
    </style>
</head>
<body>

    <div id="container-grafico">
        <canvas id="meuGrafico"></canvas>
    </div>

    <div class="area-resumo">
        <div class="card card-ativos">
            <span>Membros Ativos</span>
            <strong id="totalAtivos">0</strong>
        </div>

        <div class="card card-total">
            <span>Arrecadação Total</span>
            <strong id="arrecadacaoTotal">R$ 0,00</strong>
        </div>
    </div>

    <script>
        const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTVFsO0U3JTeEpqIks1fpNUNiHF5J6Pgyv7yYiJKFgqyI08Y_sRB2nnikRvfT4W5CcwQwAW5r0Lvt1x/pub?output=csv';
        let dadosRaw = [];
        let chart;

        const formatarMoeda = valor => valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        async function carregar() {
            try {
                const res = await fetch(url + '&cache=' + Date.now());
                const csv = await res.text();
                dadosRaw = csv.split('\n').slice(1).filter(l => l.trim()).map(l => {
                    const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());
                    let [d, m, a] = c[0].split('/');
                    return { 
                        data: c[0], 
                        mesAno: `${m}/${a}`, 
                        ano: a, 
                        valor: parseFloat(c[3].replace(/[R$\s.]/g,'').replace(',','.')) || 0, 
                        cat: c[4].toLowerCase().includes("dizimo") ? "Dízimo" : c[4],
                        telRaw: String(c[1]).replace(/\D/g, ""),
                        nome: c[2].toUpperCase().trim()
                    };
                });
                renderizar();
            } catch (e) { console.error(e); }
        }

        function renderizar(periodo = "Todos") {
            const filtrados = dadosRaw.filter(r => {
                if (periodo === "Todos") return true;
                if (periodo.length === 4) return r.ano === periodo;
                return r.mesAno === periodo;
            });

            // --- LÓGICA DOS CARDS ---
            let somaTotal = 0;
            const membrosUnicos = new Set();
            
            filtrados.forEach(r => {
                somaTotal += r.valor;
                // Só conta como membro ativo se não for "Incerto"
                if (!r.nome.includes("REMETENTE INCERTO")) {
                    membrosUnicos.add(r.telRaw || r.nome);
                }
            });

            document.getElementById('totalAtivos').innerText = membrosUnicos.size;
            document.getElementById('arrecadacaoTotal').innerText = formatarMoeda(somaTotal);

            // --- LÓGICA DO GRÁFICO ---
            const labels = [...new Set(filtrados.map(r => r.data))].sort((a, b) => {
                let [d1, m1, y1] = a.split('/'), [d2, m2, y2] = b.split('/');
                return new Date(y1, m1 - 1, d1) - new Date(y2, m2 - 1, d2);
            });

            const categorias = ["Dízimo", "Oferta", "Malawi", "Campanha"];
            const cores = { "Dízimo": "#10b981", "Oferta": "#3b82f6", "Malawi": "#f59e0b", "Campanha": "#ef4444" };

            const datasets = categorias.map(c => ({
                label: c,
                backgroundColor: cores[c],
                data: labels.map(l => filtrados.filter(r => r.data === l && r.cat === c).reduce((s, r) => s + r.valor, 0)),
                borderRadius: 4
            }));

            if (chart) chart.destroy();
            chart = new Chart(document.getElementById('meuGrafico'), {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: false },
                        y: { 
                            stacked: false, 
                            beginAtZero: true,
                            ticks: { callback: v => 'R$ ' + v.toLocaleString('pt-BR') }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }

        window.addEventListener('message', e => {
            if (e.data.periodo) renderizar(e.data.periodo);
        });

        carregar();
    </script>
</body>
</html>