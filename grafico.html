<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-card: #1a2332;
            --border: #2a3441;
            --text-primary: #f1f5f9;
            --text-muted: #64748b;
            --accent: #10b981;
        }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            padding: 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* â”€â”€ TOTAL CARD â”€â”€ */
        .card-total {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            border-bottom: 3px solid var(--accent);
            padding: 22px 24px;
            text-align: center;
            margin-bottom: 24px;
        }
        .card-total span {
            font-size: 11px; font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1.5px;
        }
        .card-total strong {
            display: block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 34px; font-weight: 700;
            color: var(--accent);
            margin-top: 8px; letter-spacing: -1px;
        }

        /* â”€â”€ CHART CONTAINER â”€â”€ */
        .chart-wrapper {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 24px;
            padding-bottom: 2px;
        }
        .chart-inner {
            min-width: 100%;
            height: 54vh;
            min-height: 340px;
            padding: 20px 24px 16px;
        }

        /* â”€â”€ SCROLLBAR â”€â”€ */
        .chart-wrapper::-webkit-scrollbar { height: 8px; }
        .chart-wrapper::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 8px;
            margin: 0 16px;
        }
        .chart-wrapper::-webkit-scrollbar-thumb {
            background: #3d4f63;
            border-radius: 8px;
            border: 2px solid var(--bg-secondary);
        }
        .chart-wrapper::-webkit-scrollbar-thumb:hover { background: #5a6f87; }

        /* â”€â”€ CATEGORY CARDS â”€â”€ */
        .area-categorias {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
        }

        .card-cat {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 20px 14px 18px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .card-cat::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 3px;
        }
        .card-cat span {
            font-size: 10px; font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .card-cat strong {
            display: block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px; font-weight: 700;
            margin-top: 10px;
            letter-spacing: -0.5px;
        }

        .cat-dizimo::after   { background: #10b981; }
        .cat-dizimo strong   { color: #10b981; }
        .cat-oferta::after   { background: #3b82f6; }
        .cat-oferta strong   { color: #3b82f6; }
        .cat-malawi::after   { background: #f59e0b; }
        .cat-malawi strong   { color: #f59e0b; }
        .cat-campanha::after { background: #ef4444; }
        .cat-campanha strong { color: #ef4444; }

        /* â”€â”€ MOBILE â”€â”€ */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .chart-inner { height: 46vh; min-height: 280px; padding: 14px 16px 12px; }
            .card-total { margin-bottom: 20px; }
            .card-total strong { font-size: 28px; }
            .chart-wrapper { margin-bottom: 20px; }
            .area-categorias { grid-template-columns: 1fr 1fr; gap: 10px; }
            .card-cat { padding: 16px 10px 14px; }
            .card-cat span { font-size: 9px; }
            .card-cat strong { font-size: 16px; margin-top: 8px; }
        }
        @media (max-width: 380px) {
            .card-cat strong { font-size: 14px; }
        }
    </style>
</head>
<body>

    <div class="card-total">
        <span>ArrecadaÃ§Ã£o Total</span>
        <strong id="arrecadacaoTotal">R$ 0,00</strong>
    </div>

    <div class="chart-wrapper">
        <div class="chart-inner" id="chartInner">
            <canvas id="meuGrafico"></canvas>
        </div>
    </div>

    <div class="area-categorias">
        <div class="card-cat cat-dizimo">
            <span>DÃ­zimo</span>
            <strong id="totalDizimo">R$ 0,00</strong>
        </div>
        <div class="card-cat cat-oferta">
            <span>Oferta</span>
            <strong id="totalOferta">R$ 0,00</strong>
        </div>
        <div class="card-cat cat-malawi">
            <span>Malawi</span>
            <strong id="totalMalawi">R$ 0,00</strong>
        </div>
        <div class="card-cat cat-campanha">
            <span>Campanha</span>
            <strong id="totalCampanha">R$ 0,00</strong>
        </div>
    </div>

    <script>
        const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTVFsO0U3JTeEpqIks1fpNUNiHF5J6Pgyv7yYiJKFgqyI08Y_sRB2nnikRvfT4W5CcwQwAW5r0Lvt1x/pub?output=csv';
        let dadosRaw = [], chart;

        const fmt = v => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        // Cria gradiente vertical para cada cor
        function makeGradient(ctx, color, alpha1 = 1, alpha2 = 0.55) {
            const hex = color.replace('#','');
            const r = parseInt(hex.slice(0,2),16);
            const g = parseInt(hex.slice(2,4),16);
            const b = parseInt(hex.slice(4,6),16);
            const grad = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
            grad.addColorStop(0, `rgba(${r},${g},${b},${alpha1})`);
            grad.addColorStop(1, `rgba(${r},${g},${b},${alpha2})`);
            return grad;
        }

        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#2a3441';

        async function carregar() {
            try {
                const res = await fetch(url + '&cache=' + Date.now());
                const csv = await res.text();
                dadosRaw = csv.split('\n').slice(1).filter(l => l.trim()).map(l => {
                    const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g,'').trim());
                    let [d,m,a] = c[0].split('/');
                    return {
                        data: c[0], mesAno: `${m}/${a}`, ano: a,
                        valor: parseFloat(c[3].replace(/[R$\s.]/g,'').replace(',','.')) || 0,
                        cat: c[4].toLowerCase().includes("dizimo") ? "DÃ­zimo" : c[4]
                    };
                });
                renderizar();
            } catch(e) { console.error(e); }
        }

        function renderizar(periodo="Todos") {
            const f = dadosRaw.filter(r =>
                periodo === "Todos" ? true
                : periodo.length === 4 ? r.ano === periodo
                : r.mesAno === periodo
            );

            const soma = f.reduce((s,r) => s+r.valor, 0);
            document.getElementById('arrecadacaoTotal').innerText = fmt(soma);
            document.getElementById('totalDizimo').innerText   = fmt(f.filter(r=>r.cat==="DÃ­zimo").reduce((s,r)=>s+r.valor,0));
            document.getElementById('totalOferta').innerText   = fmt(f.filter(r=>r.cat==="Oferta").reduce((s,r)=>s+r.valor,0));
            document.getElementById('totalMalawi').innerText   = fmt(f.filter(r=>r.cat==="Malawi").reduce((s,r)=>s+r.valor,0));
            document.getElementById('totalCampanha').innerText = fmt(f.filter(r=>r.cat==="Campanha").reduce((s,r)=>s+r.valor,0));

            const labels = [...new Set(f.map(r=>r.data))].sort((a,b) => {
                const [d1,m1,y1]=a.split('/'), [d2,m2,y2]=b.split('/');
                return new Date(y1,m1-1,d1) - new Date(y2,m2-1,d2);
            });

            // Largura dinÃ¢mica: 130px por grupo
            const totalW = Math.max(labels.length * 130 + 80, 420);
            document.getElementById('chartInner').style.width = totalW + 'px';

            // Se algum valor passa de 1500, expande a altura proporcionalmente
            const Y_MAX = 1500;
            const BASE_H = 54; // vh
            document.getElementById('chartInner').style.height = BASE_H + 'vh';

            const cats  = ["DÃ­zimo","Oferta","Malawi","Campanha"];
            const cores  = { "DÃ­zimo":"#10b981","Oferta":"#3b82f6","Malawi":"#f59e0b","Campanha":"#ef4444" };
            const realValues = {}; // guarda valor real para o tooltip mostrar corretamente

            const canvas = document.getElementById('meuGrafico');
            const ctx2d  = canvas.getContext('2d');

            // Calcula valor mÃ¡ximo para definir a altura da barra fantasma
            const maxVal = Math.max(...labels.flatMap(l =>
                cats.map(c => f.filter(r=>r.data===l&&r.cat===c).reduce((s,r)=>s+r.valor,0))
            ), 1);
            const ghostHeight = maxVal * 0.04; // 4% do mÃ¡ximo â€” barra stub visÃ­vel mas discreta

            const datasets = cats.map(c => {
                const values = labels.map(l => f.filter(r=>r.data===l&&r.cat===c).reduce((s,r)=>s+r.valor,0));
                // Guarda valores reais por label
                if (!realValues[c]) realValues[c] = {};
                labels.forEach((l, i) => realValues[c][l] = values[i]);

                // Substitui zeros por uma altura mÃ­nima visual (barra fantasma)
                const displayValues = values.map(v => v === 0 ? ghostHeight : v);

                return {
                    label: c,
                    // cores serÃ£o aplicadas por item no plugin afterDatasetDraw
                    backgroundColor: displayValues.map((v, i) =>
                        values[i] === 0
                            ? cores[c] + '28'   // fantasma: muito transparente
                            : cores[c] + 'e0'   // barra real: sÃ³lida com leve transparÃªncia
                    ),
                    hoverBackgroundColor: displayValues.map((v, i) =>
                        values[i] === 0
                            ? cores[c] + '44'
                            : cores[c]
                    ),
                    borderColor: displayValues.map((v, i) =>
                        values[i] === 0 ? cores[c] + '55' : 'transparent'
                    ),
                    borderWidth: displayValues.map((v, i) => values[i] === 0 ? 1 : 0),
                    borderDash: [4, 3],
                    data: displayValues,
                    realData: values,   // campo extra para o tooltip
                    borderRadius: 7,
                    borderSkipped: false,
                    barThickness: 22,
                    minBarLength: 18,
                };
            });

            if (chart) chart.destroy();

            // Plugin: espaÃ§o entre legenda e grÃ¡fico
            const legendGap = {
                id: 'legendGap',
                beforeInit(ch) {
                    const fit = ch.legend.fit.bind(ch.legend);
                    ch.legend.fit = function() { fit(); this.height += 24; };
                }
            };

            chart = new Chart(canvas, {
                type: 'bar',
                plugins: [legendGap],
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    categoryPercentage: 0.68,
                    barPercentage: 0.88,
                    interaction: {
                        mode: 'nearest',
                        intersect: true,
                        axis: 'xy'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: ctx => ctx.tick.value === 0 ? '#2a3441' : '#1a2740',
                                lineWidth: ctx => ctx.tick.value === 0 ? 1.5 : 1,
                            },
                            border: { display: false },
                            ticks: {
                                callback: v => 'R$ ' + v.toLocaleString('pt-BR'),
                                font: { family: "'JetBrains Mono', monospace", size: 10 },
                                maxTicksLimit: 6,
                                color: '#64748b'
                            }
                        },
                        x: {
                            grid: { display: false },
                            border: { display: false },
                            ticks: {
                                font: { family: "'DM Sans', sans-serif", size: 11, weight: '500' },
                                maxRotation: 0,
                                minRotation: 0,
                                padding: 10,
                                color: '#94a3b8'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'start',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 22,
                                font: { family: "'DM Sans', sans-serif", size: 13, weight: '600' },
                                boxHeight: 9,
                                color: '#cbd5e1'
                            }
                        },
                        tooltip: {
                            mode: 'nearest',
                            intersect: true,
                            backgroundColor: '#0f1929',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#2a3441',
                            borderWidth: 1,
                            cornerRadius: 10,
                            padding: 14,
                            displayColors: true,
                            boxWidth: 10, boxHeight: 10,
                            titleFont: { family: "'DM Sans', sans-serif", size: 12, weight: '600' },
                            bodyFont: { family: "'JetBrains Mono', monospace", size: 14, weight: '700' },
                            callbacks: {
                                title: ctx => 'ðŸ“… ' + ctx[0].label,
                                label: ctx => {
                                    // Usa o valor real, nÃ£o o display (que pode ser ghostHeight)
                                    const real = ctx.dataset.realData[ctx.dataIndex];
                                    const label = ctx.dataset.label;
                                    const icon = { "DÃ­zimo":"â—","Oferta":"â—","Malawi":"â—","Campanha":"â—" }[label] || 'â—';
                                    if (real === 0) return `  ${label}: â€”`;
                                    return `  ${label}: ${fmt(real)}`;
                                },
                                labelColor: ctx => {
                                    const cores = { "DÃ­zimo":"#10b981","Oferta":"#3b82f6","Malawi":"#f59e0b","Campanha":"#ef4444" };
                                    const c = cores[ctx.dataset.label] || '#fff';
                                    return { borderColor: c, backgroundColor: c, borderRadius: 4 };
                                }
                            }
                        }
                    }
                }
            });
        }

        window.addEventListener('message', e => {
            if (e.data.periodo) renderizar(e.data.periodo);
        });

        carregar();
    </script>
</body>
</html>
