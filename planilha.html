<!DOCTYPE html>
<html lang="pt-br">
<head><meta charset="UTF-8"><style>body{font-family:'Segoe UI',sans-serif;padding:20px;background:white;margin:0}table{width:100%;border-collapse:collapse}th{background:#f8fafc;padding:12px;text-align:left;border-bottom:2px solid #e2e8f0;color:#64748b;font-size:13px}td{padding:12px;border-bottom:1px solid #f1f5f9;font-size:14px}</style></head>
<body>
    <table>
        <thead><tr><th>Data</th><th>Telefone</th><th>Nome</th><th>Valor</th><th>Categoria</th></tr></thead>
        <tbody id="corpoTabela"></tbody>
    </table>
    <script>
        const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTVFsO0U3JTeEpqIks1fpNUNiHF5J6Pgyv7yYiJKFgqyI08Y_sRB2nnikRvfT4W5CcwQwAW5r0Lvt1x/pub?output=csv';
        let registros = [];
        
        const padronizarTel = t => {
            let n = String(t).replace(/\D/g, "");
            if(n.length <= 11) n = "55" + (n.length <= 9 ? "24" : "") + (n.length===8?"9":"") + n;
            return n.length >= 12 ? `+${n.substring(0,2)} (${n.substring(2,4)}) ${n.substring(4,9)}-${n.substring(9,13)}` : "N/A";
        };

        async function carregar() {
            const res = await fetch(url + '&cache=' + Date.now());
            const csv = await res.text();
            registros = csv.split('\n').slice(1).filter(l=>l.trim()).map(l=>{
                const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v=>v.replace(/^"|"$/g,'').trim());
                let [d,m,a] = c[0].split('/');
                return { 
                    data: c[0], mesAno: `${m}/${a}`, ano: a,
                    tel: padronizarTel(c[1]), nome: c[2].toUpperCase(), 
                    valor: c[3], cat: c[4].toLowerCase().includes("dizimo") ? "DÃ­zimo" : c[4],
                    sort: new Date(a, m-1, d)
                };
            }).sort((a,b)=>b.sort - a.sort);
            renderizar();
        }

        function renderizar(cat="Todas", periodo="Todos") {
            const f = registros.filter(r => {
                const matchCat = (cat === "Todas" || r.cat === cat);
                let matchPeriodo = false;

                if (periodo === "Todos") matchPeriodo = true;
                else if (periodo.length === 4) matchPeriodo = (r.ano === periodo); // Filtro anual
                else matchPeriodo = (r.mesAno === periodo); // Filtro mensal

                return matchCat && matchPeriodo;
            });

            document.getElementById('corpoTabela').innerHTML = f.map(r=>`<tr><td>${r.data}</td><td>${r.tel}</td><td>${r.nome}</td><td>${r.valor}</td><td>${r.cat}</td></tr>`).join('');
        }

        window.addEventListener('message', e => renderizar(e.data.categoria, e.data.periodo));
        carregar();
    </script>
</body>
</html>